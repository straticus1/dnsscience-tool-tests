# DNS Science Apache Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

<VirtualHost *:80>
    ServerName {{ apache_server_name }}
    ServerAdmin {{ apache_server_admin }}

    # Document Root
    DocumentRoot {{ apache_document_root }}

    # WSGI Configuration
    WSGIDaemonProcess dnsscience python-home={{ venv_path }} python-path={{ app_dir }} processes={{ flask_workers }} threads=15 display-name=%{GROUP}
    WSGIProcessGroup dnsscience
    WSGIScriptAlias / {{ app_dir }}/dnsscience.wsgi

    # Directory Permissions
    <Directory {{ app_dir }}>
        Require all granted
        Options -Indexes +FollowSymLinks
        AllowOverride All
    </Directory>

    <Directory {{ template_dir }}>
        Require all granted
        Options -Indexes +FollowSymLinks
        AllowOverride None

        # PHP Configuration for templates
        <FilesMatch \.php$>
            SetHandler application/x-httpd-php
        </FilesMatch>
    </Directory>

    # Static Files
    Alias /static {{ static_dir }}
    <Directory {{ static_dir }}>
        Require all granted
        Options -Indexes

        # Cache Control
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/jpg "access plus 1 month"
            ExpiresByType image/jpeg "access plus 1 month"
            ExpiresByType image/gif "access plus 1 month"
            ExpiresByType image/png "access plus 1 month"
            ExpiresByType text/css "access plus 1 week"
            ExpiresByType application/javascript "access plus 1 week"
            ExpiresByType text/javascript "access plus 1 week"
        </IfModule>
    </Directory>

    # Template Files Direct Access
    Alias /explorer {{ template_dir }}/explorer.html
    Alias /tools {{ template_dir }}/tools.html
    Alias /pricing {{ template_dir }}/pricing.html
    Alias /services {{ template_dir }}/services.html
    Alias /registrar {{ template_dir }}/registrar.html
    Alias /api-docs {{ template_dir }}/api_docs.html
    Alias /cli-docs {{ template_dir }}/cli_docs.html

    # Proxy Pass for specific routes
    ProxyPass /api http://127.0.0.1:{{ flask_port }}/api
    ProxyPassReverse /api http://127.0.0.1:{{ flask_port }}/api

    ProxyPass /autolookup http://127.0.0.1:{{ flask_port }}/autolookup
    ProxyPassReverse /autolookup http://127.0.0.1:{{ flask_port }}/autolookup

    ProxyPass /visualtrace http://127.0.0.1:{{ flask_port }}/visualtrace
    ProxyPassReverse /visualtrace http://127.0.0.1:{{ flask_port }}/visualtrace

    ProxyPass /health http://127.0.0.1:{{ flask_port }}/health
    ProxyPassReverse /health http://127.0.0.1:{{ flask_port }}/health

    # Logging
    ErrorLog {{ log_dir }}/error.log
    CustomLog {{ log_dir }}/access.log combined

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Error Pages
    ErrorDocument 404 /static/404.html
    ErrorDocument 500 /static/500.html
    ErrorDocument 503 /static/503.html

{% if force_ssl | default(false) %}
    # Force SSL Redirect
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
{% endif %}
</VirtualHost>

{% if enable_ssl | default(false) %}
<VirtualHost *:443>
    ServerName {{ apache_server_name }}
    ServerAdmin {{ apache_server_admin }}

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile {{ ssl_cert_path }}
    SSLCertificateKeyFile {{ ssl_key_path }}
    {% if ssl_chain_path is defined %}
    SSLCertificateChainFile {{ ssl_chain_path }}
    {% endif %}

    # Modern SSL Configuration
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on

    # HSTS Header
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Include all configurations from port 80
    Include /etc/httpd/conf.d/dnsscience-shared.conf
</VirtualHost>
{% endif %}