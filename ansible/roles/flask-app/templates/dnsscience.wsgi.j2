#!/usr/bin/python3
# DNS Science WSGI Application
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

import sys
import os
import logging

# Add virtual environment to path
activate_this = '{{ venv_path }}/bin/activate_this.py'
if os.path.exists(activate_this):
    with open(activate_this) as file_:
        exec(file_.read(), dict(__file__=activate_this))

# Add application directory to path
sys.path.insert(0, '{{ app_dir }}')
os.chdir('{{ app_dir }}')

# Set environment variables
os.environ['FLASK_ENV'] = '{{ flask_env }}'
os.environ['DB_HOST'] = '{{ db_host }}'
os.environ['DB_PORT'] = '{{ db_port }}'
os.environ['DB_NAME'] = '{{ db_name }}'
os.environ['DB_USER'] = '{{ db_user }}'
os.environ['DB_PASSWORD'] = '{{ db_password }}'
os.environ['REDIS_HOST'] = '{{ redis_host }}'
os.environ['REDIS_PORT'] = '{{ redis_port }}'
os.environ['SECRET_KEY'] = '{{ secret_key }}'
os.environ['STRIPE_SECRET_KEY'] = '{{ stripe_secret_key }}'
os.environ['STRIPE_PUBLISHABLE_KEY'] = '{{ stripe_publishable_key }}'
os.environ['OPENSRS_API_KEY'] = '{{ opensrs_api_key }}'
os.environ['GOOGLE_MAPS_API_KEY'] = '{{ google_maps_api_key }}'

# Configure logging
logging.basicConfig(
    level=logging.{{ log_level }},
    format='{{ log_format }}',
    handlers=[
        logging.FileHandler('{{ log_dir }}/app.log'),
        logging.StreamHandler()
    ]
)

# Import Flask application
try:
    from app import app as application
    logging.info('DNS Science WSGI application loaded successfully')
except Exception as e:
    logging.error(f'Failed to load application: {str(e)}')
    raise

# Add WSGI middleware for monitoring if enabled
{% if enable_monitoring %}
try:
    from werkzeug.middleware.profiler import ProfilerMiddleware
    application = ProfilerMiddleware(application, restrictions=[30])
except ImportError:
    pass
{% endif %}

# Add WSGI middleware for debugging if enabled
{% if debug_mode %}
from werkzeug.debug import DebuggedApplication
application = DebuggedApplication(application, evalex=True)
{% endif %}

# Application configuration
application.config.update(
    DEBUG={{ flask_debug | lower }},
    TESTING=False,
    SECRET_KEY='{{ secret_key }}',
    SESSION_COOKIE_SECURE={{ secure_cookies | lower }},
    SESSION_COOKIE_HTTPONLY=True,
    SESSION_COOKIE_SAMESITE='Lax',
    PERMANENT_SESSION_LIFETIME={{ session_lifetime }},
    MAX_CONTENT_LENGTH={{ max_content_length }},
    JSON_SORT_KEYS=False,
    JSONIFY_PRETTYPRINT_REGULAR=False
)

if __name__ == '__main__':
    application.run(host='0.0.0.0', port={{ flask_port }}, debug={{ flask_debug | lower }})